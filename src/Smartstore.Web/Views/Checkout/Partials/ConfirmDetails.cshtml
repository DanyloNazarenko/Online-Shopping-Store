@using Smartstore.Core.Checkout.Cart
@using Smartstore.Web.Models.Checkout

@model CheckoutConfirmModel

@{
    var cart = Model.ShoppingCart;
    var termsLinkTemplate = "<a class='terms-trigger read' href='{0}' data-toggle='modal' data-target='#terms-of-service-modal'>";
    var disclaimerLink = termsLinkTemplate.FormatInvariant(await Url.TopicAsync("Disclaimer", true));
    var privacyLink = termsLinkTemplate.FormatInvariant(await Url.TopicAsync("PrivacyInfo", true));

    var termsLink = termsLinkTemplate.FormatInvariant(await Url.TopicAsync("ConditionsOfUse", true));
    var terms = T("Checkout.TermsOfService.IAccept", termsLink, "</a>", disclaimerLink, privacyLink);

    var showConsentBox = Model.TermsOfServiceEnabled
        || Model.NewsletterSubscription != CheckoutNewsletterSubscription.None
        || Model.ThirdPartyEmailHandOver != CheckoutThirdPartyEmailHandOver.None
        || await Display.ZoneHasWidgetsAsync("checkout_submit_data_consent");
}

<input type="hidden" id="customercommenthidden" name="customercommenthidden" />

<p class="page-intro lead">
    @Html.Raw(T("Checkout.ConfirmHint"))
</p>

<div sm-if="showConsentBox" id="terms-of-service-consent-box" class="card mb-3">
    <div class="card-body">
        @if (Model.TermsOfServiceEnabled)
        {
            <div class="form-check">
                <input id="termsofservice" type="checkbox" name="termsofservice" class="form-check-input" />
                <label class="mb-0 form-check-label" for="termsofservice">@Html.Raw(terms)</label>
            </div>

            <modal id="terms-of-service-modal" sm-render-at-page-end="true" sm-size="FlexSmall">
                <modal-body></modal-body>
                <modal-footer>
                    <button class="btn btn-secondary" data-dismiss="modal">@T("Common.Confirm")</button>
                </modal-footer>
            </modal>
        }

        <div sm-if="Model.NewsletterSubscription != CheckoutNewsletterSubscription.None" class="form-check">
            <input attr-checked='(Model.NewsletterSubscription == CheckoutNewsletterSubscription.Activated, "checked")'
                   type="checkbox" id="SubscribeToNewsletter" name="SubscribeToNewsletter" class="form-check-input" />
            <label class="form-check-label" for="SubscribeToNewsletter">
                <span>@T("Checkout.SubscribeToNewsletter")</span>
            </label>
        </div>

        <div sm-if="Model.ThirdPartyEmailHandOver != CheckoutThirdPartyEmailHandOver.None" class="form-check">
            <input attr-checked='(Model.ThirdPartyEmailHandOver == CheckoutThirdPartyEmailHandOver.Activated, "checked")'
                   type="checkbox" id="AcceptThirdPartyEmailHandOver" name="AcceptThirdPartyEmailHandOver" class="form-check-input" />
            <label class="form-check-label" for="AcceptThirdPartyEmailHandOver">
                <span>@Model.ThirdPartyEmailHandOverLabel</span>
            </label>
        </div>

        <zone name="checkout_submit_data_consent" />
    </div>
</div>

<div id="confirm-warnings" class="confirm-order">
    <div sm-if="Model.Warnings.Count > 0" class="alert alert-danger mb-3">
        <ul>
            @foreach (var warning in Model.Warnings)
            {
                <li>@Html.Raw(warning)</li>
            }
        </ul>
    </div>
</div>

<zone name="checkout_confirm_before_summary" />
<zone name="order_summary_content_before" />

<partial name="OrderReviewData" model="cart.OrderReviewData" />

@if (cart.DisplayCommentBox)
{
    <partial name="_CommentBox" model="cart" />
}

@if (cart.Items.Any())
{
    <div>
        <div sm-if="Model.IsConfirmPage" class="row align-items-end mb-2">
            <div class="col">
                <span class="h5">
                    @Html.Raw(T("ShoppingCart.Products"))
                </span>
            </div>
            <div class="col col-auto">
                <a href="@Url.RouteUrl("ShoppingCart")" class="btn btn-secondary btn-sm">
                    <i class="fa fa-angle-left"></i>
                    <span>@T("ShoppingCart.BackToCart")</span>
                </a>
            </div>
        </div>
        <div id="cart-warnings">
            <partial name="CartWarnings" model="cart.Warnings" />
        </div>
        <div id="cart-items" class="cart">
            <div class="cart-body">
                <partial name="CartItems" model="cart" />
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-warning fade show">
        @T("ShoppingCart.CartIsEmpty")
    </div>
}

<div class="cart-bottom-order-total">
    <div class="row">
        <div class="col col-auto">
            <button type="button" class="btn btn-danger btn-lg @Model.NextStepClass" onclick="return false;">
                <span>@T("Checkout.ConfirmButton")</span>
                <i class="fa fa-angle-right"></i>
            </button>
        </div>
        <div class="col col-3">
            <zone name="order_bottom_totals_before" />

            @await Component.InvokeAsync("OrderTotals", new { orderTotalOnly = true })

            <zone name="order_bottom_totals_after" />
        </div>
    </div>
    @*<div class="row">
        <div class="col text-muted mt-2">
            Interactively procrastinate prospective vortals vis-a-vis 24/7 meta-services. Appropriately deploy prospective "outside the box" thinking without functional deliverables. Intrinsicly brand enabled potentialities for customer directed best practices. Phosfluorescently scale extensible strategic theme areas for.
        </div>
    </div>*@
</div>

<zone name="order_summary_content_after" />

@if (cart.Items.Any(x => x.IsDownload && x.HasUserAgreement))
{
    <modal id="user-agreement-modal" sm-render-at-page-end="true" sm-center-vertically="true" sm-size="FlexSmall">
        <modal-body></modal-body>
        <modal-footer>
            <button class="btn btn-secondary" data-dismiss="modal">@T("Common.Confirm")</button>
        </modal-footer>
    </modal>
}
